apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: azure-environment-composition
spec:
  # must match your XRD apiVersion + kind
  compositeTypeRef:
    apiVersion: platform.ihk.org/v1alpha1
    kind: Environment
  mode: Pipeline
  pipeline:
    - step: patch-and-transform
      functionRef:
        name: crossplane-contrib-function-patch-and-transform
      input:
        apiVersion: pt.fn.crossplane.io/v1beta1
        kind: Resources
        # The function will return a list of desired resources.
        resources:
          # 1. Resource Group
          - name: resourceGroup
            base:
              apiVersion: azure.m.upbound.io/v1beta1
              kind: ResourceGroup
              spec:
                forProvider:
                  location: "West Europe"
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.resourceGroup.name"
                toFieldPath: "metadata.name"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.resourceGroup.name"
                toFieldPath: "metadata.labels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "metadata.labels[crossplane.io/namespace]"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.environment.owner"
                toFieldPath: "spec.forProvider.tags.owner"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.environment.purpose"
                toFieldPath: "spec.forProvider.tags.purpose"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.region"
                toFieldPath: "spec.forProvider.location"

          # 2. Virtual Network
          - name: virtualNetwork
            base:
              apiVersion: network.azure.m.upbound.io/v1beta1
              kind: VirtualNetwork
              spec:
                forProvider:
                  addressSpace: ["10.0.0.0/16"]
                  resourceGroupNameSelector:
                    matchLabels:
                  location: "West Europe"
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.network.vnet.name"
                toFieldPath: "metadata.name"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.network.vnet.addressSpace"
                toFieldPath: "spec.forProvider.addressSpace[0]"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.region"
                toFieldPath: "spec.forProvider.location"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.network.vnet.name"
                toFieldPath: "metadata.labels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "metadata.labels[crossplane.io/namespace]"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.resourceGroup.name"
                toFieldPath: "spec.forProvider.resourceGroupNameSelector.matchLabels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "spec.forProvider.resourceGroupNameSelector.matchLabels[crossplane.io/namespace]"

          # 3. Subnet for AKS
          - name: subnetAks
            base:
              apiVersion: network.azure.m.upbound.io/v1beta1
              kind: Subnet
              metadata:
              spec:
                forProvider:
                  addressPrefixes: ["10.0.1.0/24"]
                  resourceGroupNameSelector:
                    matchLabels:
                  virtualNetworkNameSelector:
                    matchLabels:
            patches:
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "spec.network.vnet.name"
                  - fromFieldPath: "spec.network.subnets[0].name"
                  strategy: string
                  string:
                    fmt: "%s-%s"
                toFieldPath: "metadata.name"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.network.subnets[0].addressPrefix"
                toFieldPath: "spec.forProvider.addressPrefixes[0]"
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "spec.network.vnet.name"
                  - fromFieldPath: "spec.network.subnets[0].name"
                  strategy: string
                  string:
                    fmt: "%s-%s"
                toFieldPath: "metadata.labels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "metadata.labels[crossplane.io/namespace]"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.resourceGroup.name"
                toFieldPath: "spec.forProvider.resourceGroupNameSelector.matchLabels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "spec.forProvider.resourceGroupNameSelector.matchLabels[crossplane.io/namespace]"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.network.vnet.name"
                toFieldPath: "spec.forProvider.virtualNetworkNameSelector.matchLabels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "spec.forProvider.virtualNetworkNameSelector.matchLabels[crossplane.io/namespace]"

          # 3b. Subnet for Database
          - name: subnetDb
            base:
              apiVersion: network.azure.m.upbound.io/v1beta1
              kind: Subnet
              spec:
                forProvider:
                  addressPrefixes: ["10.0.2.0/24"]
                  resourceGroupNameSelector:
                    matchLabels:
                  virtualNetworkNameSelector:              
                    matchLabels:
                  serviceEndpoints:
                  - Microsoft.Storage
                  delegation:
                  - name: fs
                    serviceDelegation:
                      actions:
                      - Microsoft.Network/virtualNetworks/subnets/join/action
                      name: Microsoft.DBforPostgreSQL/flexibleServers
            patches:
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "spec.network.vnet.name"
                  - fromFieldPath: "spec.network.subnets[1].name"
                  strategy: string
                  string:
                    fmt: "%s-%s"
                toFieldPath: "metadata.name"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.network.subnets[1].addressPrefix"
                toFieldPath: "spec.forProvider.addressPrefixes[0]"
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "spec.network.vnet.name"
                  - fromFieldPath: "spec.network.subnets[1].name"
                  strategy: string
                  string:
                    fmt: "%s-%s"
                toFieldPath: "metadata.labels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "metadata.labels[crossplane.io/namespace]"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.resourceGroup.name"
                toFieldPath: "spec.forProvider.resourceGroupNameSelector.matchLabels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "spec.forProvider.resourceGroupNameSelector.matchLabels[crossplane.io/namespace]"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.network.vnet.name"
                toFieldPath: "spec.forProvider.virtualNetworkNameSelector.matchLabels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "spec.forProvider.virtualNetworkNameSelector.matchLabels[crossplane.io/namespace]"

          # 3c. Private DNS Zone
          - name: privateDnsZone
            base:
              apiVersion: network.azure.m.upbound.io/v1beta1
              kind: PrivateDNSZone
              spec:
                forProvider:
                  resourceGroupNameSelector:
                    matchLabels:
            patches:
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "metadata.name"
                  strategy: string
                  string:
                    fmt: "%s.postgres.database.azure.com"
                toFieldPath: "metadata.name"
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "metadata.name"
                  strategy: string
                  string:
                    fmt: "%s.postgres.database.azure.com"
                toFieldPath: "metadata.labels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "metadata.labels[crossplane.io/namespace]"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.resourceGroup.name"
                toFieldPath: "spec.forProvider.resourceGroupNameSelector.matchLabels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "spec.forProvider.resourceGroupNameSelector.matchLabels[crossplane.io/namespace]"

          # 3d. Private DNS Zone Virtual Network Link
          - name: privateDnsZoneVnetLink
            base:
              apiVersion: network.azure.m.upbound.io/v1beta1
              kind: PrivateDNSZoneVirtualNetworkLink
              spec:
                forProvider:
                  privateDnsZoneNameSelector:
                    matchLabels:
                  resourceGroupNameSelector:
                    matchLabels:
                  virtualNetworkIdSelector:
                    matchLabels:
            patches:
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "metadata.name"
                  strategy: string
                  string:
                    fmt: "%s.postgres.database.azure.com-vnet-link"
                toFieldPath: "metadata.name"
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "metadata.name"
                  strategy: string
                  string:
                    fmt: "%s.postgres.database.azure.com-vnet-link"
                toFieldPath: "metadata.labels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "metadata.labels[crossplane.io/namespace]"
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "metadata.name"
                  strategy: string
                  string:
                    fmt: "%s.postgres.database.azure.com"
                toFieldPath: "spec.forProvider.privateDnsZoneNameSelector.matchLabels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "spec.forProvider.privateDnsZoneNameSelector.matchLabels[crossplane.io/namespace]"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.resourceGroup.name"
                toFieldPath: "spec.forProvider.resourceGroupNameSelector.matchLabels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "spec.forProvider.resourceGroupNameSelector.matchLabels[crossplane.io/namespace]"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.network.vnet.name"
                toFieldPath: "spec.forProvider.virtualNetworkIdSelector.matchLabels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "spec.forProvider.virtualNetworkIdSelector.matchLabels[crossplane.io/namespace]"

          # 4. AKS Cluster
          - name: aksCluster
            base:
              apiVersion: containerservice.azure.m.upbound.io/v1beta1
              kind: KubernetesCluster
              spec:
                forProvider:
                  defaultNodePool:
                    name: default
                    nodeCount: 2
                    vmSize: Standard_D2_v2
                    osSku: "Ubuntu2204"
                    vnetSubnetIdSelector:
                      matchLabels:
                  dnsPrefix: "aks"
                  identity:
                    type: SystemAssigned
                  location: "West Europe"
                  resourceGroupNameSelector:
                    matchLabels:
                  kubernetesVersion: "1.30.0"
                  networkProfile:
                    networkPlugin: "azure"
                    networkPolicy: "calico"
                  tags:
                    provisioner: crossplane
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.aks.name"
                toFieldPath: "metadata.name"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.region"
                toFieldPath: "spec.forProvider.location"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.aks.name"
                toFieldPath: "metadata.labels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "metadata.labels[crossplane.io/namespace]"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.aks.nodeCount"
                toFieldPath: "spec.forProvider.defaultNodePool.nodeCount"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.aks.nodeSku"
                toFieldPath: "spec.forProvider.defaultNodePool.vmSize"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.aks.nodeImage"
                toFieldPath: "spec.forProvider.defaultNodePool.osSku"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.aks.version"
                toFieldPath: "spec.forProvider.kubernetesVersion"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.aks.networkProfile.networkPlugin"
                toFieldPath: "spec.forProvider.networkProfile.networkPlugin"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.aks.networkProfile.networkPolicy"
                toFieldPath: "spec.forProvider.networkProfile.networkPolicy"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.aks.networkProfile.serviceCidr"
                toFieldPath: "spec.forProvider.networkProfile.serviceCidr"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.aks.networkProfile.dnsServiceIp"
                toFieldPath: "spec.forProvider.networkProfile.dnsServiceIp"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.aks.name"
                toFieldPath: "spec.forProvider.nodeResourceGroup"
              - type: ToCompositeFieldPath
                fromFieldPath: "status.atConnection.kubeconfig"
                toFieldPath: "connectionDetails.KUBECONFIG"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.resourceGroup.name"
                toFieldPath: "spec.forProvider.resourceGroupNameSelector.matchLabels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "spec.forProvider.resourceGroupNameSelector.matchLabels[crossplane.io/namespace]"
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "spec.network.vnet.name"
                  - fromFieldPath: "spec.network.subnets[0].name"
                  strategy: string
                  string:
                    fmt: "%s-%s"
                toFieldPath: "spec.forProvider.defaultNodePool.vnetSubnetIdSelector.matchLabels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "spec.forProvider.defaultNodePool.vnetSubnetIdSelector.matchLabels[crossplane.io/namespace]"

          # 5. AKS Node Pool
          - name: aksNodePool
            base:
              apiVersion: containerservice.azure.m.upbound.io/v1beta1
              kind: KubernetesClusterNodePool
              metadata:
                name: workerpool
              spec:
                forProvider:
                  kubernetesClusterIdSelector:
                    matchControllerRef: true
                  nodeCount: 2
                  mode: User
                  tags:
                    provisioner: crossplane
                  vmSize: Standard_D2_v2
                  vnetSubnetIdSelector:
                    matchLabels:
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.aks.name"
                toFieldPath: "metadata.labels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "metadata.labels[crossplane.io/namespace]"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.aks.nodeCount"
                toFieldPath: "spec.forProvider.nodeCount"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.aks.nodeSku"
                toFieldPath: "spec.forProvider.vmSize"
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "spec.network.vnet.name"
                  - fromFieldPath: "spec.network.subnets[0].name"
                  strategy: string
                  string:
                    fmt: "%s-%s"
                toFieldPath: "spec.forProvider.vnetSubnetIdSelector.matchLabels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "spec.forProvider.vnetSubnetIdSelector.matchLabels[crossplane.io/namespace]"

          # 6. Azure Key Vault
          - name: keyVault
            base:
              apiVersion: keyvault.azure.m.upbound.io/v1beta1
              kind: Vault
              spec:
                forProvider:
                  location: "West Europe"
                  resourceGroupNameSelector:
                    matchLabels:
                  skuName: "standard"
                  enabledForDeployment: true
                  enabledForDiskEncryption: true
                  enabledForTemplateDeployment: true
                  enableRbacAuthorization: true
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.keyVault.name"
                toFieldPath: "metadata.name"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.keyVault.name"
                toFieldPath: "metadata.labels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "metadata.labels[crossplane.io/namespace]"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.region"
                toFieldPath: "spec.forProvider.location"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.keyVault.sku"
                toFieldPath: "spec.forProvider.skuName"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.resourceGroup.name"
                toFieldPath: "spec.forProvider.resourceGroupNameSelector.matchLabels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "spec.forProvider.resourceGroupNameSelector.matchLabels[crossplane.io/namespace]"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.identity.tenantId"
                toFieldPath: "spec.forProvider.tenantId"
              - type: ToCompositeFieldPath
                fromFieldPath: "status.atConnection.vaultUri"
                toFieldPath: "connectionDetails.KEYVAULT_URI"

          # 10. Key Vault Role Assignment
          - name: keyVaultRoleAssignment
            base:
              apiVersion: authorization.azure.m.upbound.io/v1beta1
              kind: RoleAssignment
              spec:
                forProvider:
                  principalId: "Service Principal Object ID"
                  roleDefinitionName: "Key Vault Secrets Officer"
            patches:
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "metadata.name"
                  - fromFieldPath: "spec.keyVault.name"
                  strategy: string
                  string:
                    fmt: "%s-%s-role-assignment"
                toFieldPath: "metadata.name"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "metadata.labels[crossplane.io/namespace]"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.identity.principalId"
                toFieldPath: "spec.forProvider.principalId"
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "spec.keyVault.name"
                  strategy: string
                  string:
                    fmt: "/subscriptions/c7168f05-81e4-4d55-9647-af014666725d/resourceGroups/rg-devenv123/providers/Microsoft.KeyVault/vaults/%s"
                toFieldPath: "spec.forProvider.scope"

          # 8. PostgreSQL Server
          - name: postgresqlServer
            base:
              apiVersion: dbforpostgresql.azure.m.upbound.io/v1beta1
              kind: FlexibleServer
              spec:
                forProvider:
                  administratorLogin: "psqladmin"
                  administratorPasswordSecretRef:
                    name: db-admin-password
                    key: password
                  location: "West Europe"
                  resourceGroupNameSelector:
                    matchLabels:
                  privateDnsZoneIdSelector:
                    matchLabels:
                  skuName: "B_Standard_B1ms"
                  storageMb: 32768
                  version: "16"
                  storageTier: P4
                  delegatedSubnetIdSelector:
                    matchLabels:
                  publicNetworkAccessEnabled: false
                  zone: "1"
                writeConnectionSecretToRef:
                  name: db-connection-info
            patches:
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "metadata.name"
                  - fromFieldPath: "spec.database.dbName"
                  strategy: string
                  string:
                    fmt: "%s-%s-server"
                toFieldPath: "metadata.name"
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "metadata.name"
                  - fromFieldPath: "spec.database.dbName"
                  strategy: string
                  string:
                    fmt: "%s-%s-server"
                toFieldPath: "metadata.labels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "metadata.labels[crossplane.io/namespace]"
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "metadata.name"
                  - fromFieldPath: "spec.database.dbName"
                  strategy: string
                  string:
                    fmt: "%s-%s-server"
                toFieldPath: "spec.writeConnectionSecretToRef.name"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.region"
                toFieldPath: "spec.forProvider.location"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.database.sku"
                toFieldPath: "spec.forProvider.skuName"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.database.storageMb"
                toFieldPath: "spec.forProvider.storageMb"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.database.version"
                toFieldPath: "spec.forProvider.version"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.resourceGroup.name"
                toFieldPath: "spec.forProvider.resourceGroupNameSelector.matchLabels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "spec.forProvider.resourceGroupNameSelector.matchLabels[crossplane.io/namespace]"
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "spec.network.vnet.name"
                  - fromFieldPath: "spec.network.subnets[1].name"
                  strategy: string
                  string:
                    fmt: "%s-%s"
                toFieldPath: "spec.forProvider.delegatedSubnetIdSelector.matchLabels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "spec.forProvider.delegatedSubnetIdSelector.matchLabels[crossplane.io/namespace]"
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "metadata.name"
                  strategy: string
                  string:
                    fmt: "%s.postgres.database.azure.com"
                toFieldPath: "spec.forProvider.privateDnsZoneIdSelector.matchLabels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "spec.forProvider.privateDnsZoneIdSelector.matchLabels[crossplane.io/namespace]"
              - type: ToCompositeFieldPath
                fromFieldPath: "status.atConnection.fqdn"
                toFieldPath: "connectionDetails.DB_HOST"
              - type: ToCompositeFieldPath
                fromFieldPath: "status.atConnection.loginName"
                toFieldPath: "connectionDetails.DB_USER"
              - type: ToCompositeFieldPath
                fromFieldPath: "status.atConnection.loginPassword"
                toFieldPath: "connectionDetails.DB_PASSWORD"

          # 9. PostgreSQL Database
          - name: postgresqlDatabase
            base:
              apiVersion: dbforpostgresql.azure.m.upbound.io/v1beta1
              kind: FlexibleServerDatabase
              spec:
                forProvider:
                  charset: "UTF8"
                  collation: "en_US.utf8"
                  serverIdSelector:
                    matchLabels:
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.database.dbName"
                toFieldPath: "metadata.name"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.database.dbName"
                toFieldPath: "metadata.labels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "metadata.labels[crossplane.io/namespace]"
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "metadata.name"
                  - fromFieldPath: "spec.database.dbName"
                  strategy: string
                  string:
                    fmt: "%s-%s-server"
                toFieldPath: "spec.forProvider.serverIdSelector.matchLabels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "spec.forProvider.serverIdSelector.matchLabels[crossplane.io/namespace]"
              - type: ToCompositeFieldPath
                fromFieldPath: "status.atConnection.databaseName"
                toFieldPath: "connectionDetails.DB_NAME"

          # 11. Key Vault Secret for DB Password
          - name: keyVaultSecretDbPassword
            base:
              apiVersion: keyvault.azure.m.upbound.io/v1beta1
              kind: Secret
              spec:
                forProvider:
                  keyVaultIdSelector:
                    matchLabels:
                  name: "db-password"
                  valueSecretRef:
                    name: db-connection-info
                    key: password
            patches:
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "metadata.name"
                  - fromFieldPath: "spec.keyVault.name"
                  strategy: string
                  string:
                    fmt: "%s-%s-db-password"
                toFieldPath: "metadata.name"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "metadata.labels[crossplane.io/namespace]"
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.keyVault.name"
                toFieldPath: "spec.forProvider.keyVaultIdSelector.matchLabels[crossplane.io/external-resource-name]"
              - type: FromCompositeFieldPath
                fromFieldPath: "metadata.namespace"
                toFieldPath: "spec.forProvider.keyVaultIdSelector.matchLabels[crossplane.io/namespace]"
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: "metadata.name"
                  - fromFieldPath: "spec.database.dbName"
                  strategy: string
                  string:
                    fmt: "%s-%s-server"
                toFieldPath: "spec.forProvider.valueSecretRef.name"
